'use strict';function a1_0x279d(_0xe51dad,_0x23d9e2){const _0x450003=a1_0x4500();return a1_0x279d=function(_0x279d03,_0x4fef01){_0x279d03=_0x279d03-0x7c;let _0xa6cb77=_0x450003[_0x279d03];return _0xa6cb77;},a1_0x279d(_0xe51dad,_0x23d9e2);}function a1_0x4500(){const _0xd504fa=['1204QaKibZ','10300bwqVRO','X509Certificate','9mfYutd','_signerCertificate','then','from','../error/InvalidCertificateChainError','data','sort','237KGScLP','_trustedRootCert','Invalid\x20certificate\x20chain\x20validation\x20of\x20signer\x20certificate','camdigikey_signer_certificates','getTime','1372360KCcRli','10615arZDhP','length','871731yAgvwl','ACCESS_TOKEN_CERT_URL','split','findOne','readFileSync','env','../error/CamDigiKeyError','parse','_db','compareTwoPrincipals','application/json','crypto','subject','CAMDIGIKEY_CLIENT_KEYSTORE_FILE_PASSWORD','insert','throw','CAMDIGIKEY_CLIENT_KEYSTORE_FILE','verifyCertificateChain','done','default','value','get','next','certificate','request','publicKey','now','7231038oTGXQg','includes','validTo','verify','message','Error\x20requesting\x20to\x20CamDigiKey\x20Server.','__importDefault','assign','cert_chain','every','/api/v1.5/certificates/access-token-certificate-chain','signer_cert','getCertificateFromCamDigiKey','5XiLImm','1320160aEgmik','1377076lAZDYJ','signerCertificate','push','defineProperty'];a1_0x4500=function(){return _0xd504fa;};return a1_0x4500();}const a1_0x4494da=a1_0x279d;(function(_0x4b36fe,_0x441d10){const _0x516302=a1_0x279d,_0x37344e=_0x4b36fe();while(!![]){try{const _0x41c292=parseInt(_0x516302(0xa6))/0x1+-parseInt(_0x516302(0xa7))/0x2+-parseInt(_0x516302(0xb5))/0x3*(parseInt(_0x516302(0xab))/0x4)+parseInt(_0x516302(0xa5))/0x5*(parseInt(_0x516302(0x98))/0x6)+parseInt(_0x516302(0x7d))/0x7+parseInt(_0x516302(0xba))/0x8*(-parseInt(_0x516302(0xae))/0x9)+-parseInt(_0x516302(0xac))/0xa*(parseInt(_0x516302(0xbb))/0xb);if(_0x41c292===_0x441d10)break;else _0x37344e['push'](_0x37344e['shift']());}catch(_0x42c17f){_0x37344e['push'](_0x37344e['shift']());}}}(a1_0x4500,0xbc7d6));var __awaiter=this&&this['__awaiter']||function(_0x125880,_0x35b892,_0x2847c0,_0x1ea873){function _0x5d35db(_0x47678d){return _0x47678d instanceof _0x2847c0?_0x47678d:new _0x2847c0(function(_0x4424b0){_0x4424b0(_0x47678d);});}return new(_0x2847c0||(_0x2847c0=Promise))(function(_0x4a08bd,_0x70ffa1){const _0x5a64d1=a1_0x279d;function _0x1048ea(_0x23df53){const _0x207f27=a1_0x279d;try{_0x46e4b0(_0x1ea873[_0x207f27(0x93)](_0x23df53));}catch(_0x469598){_0x70ffa1(_0x469598);}}function _0x368332(_0x567dfa){const _0x324347=a1_0x279d;try{_0x46e4b0(_0x1ea873[_0x324347(0x8c)](_0x567dfa));}catch(_0x497347){_0x70ffa1(_0x497347);}}function _0x46e4b0(_0x3e629f){const _0x5f1a44=a1_0x279d;_0x3e629f[_0x5f1a44(0x8f)]?_0x4a08bd(_0x3e629f[_0x5f1a44(0x91)]):_0x5d35db(_0x3e629f[_0x5f1a44(0x91)])[_0x5f1a44(0xb0)](_0x1048ea,_0x368332);}_0x46e4b0((_0x1ea873=_0x1ea873['apply'](_0x125880,_0x35b892||[]))[_0x5a64d1(0x93)]());});},__importDefault=this&&this[a1_0x4494da(0x9e)]||function(_0x85feb5){return _0x85feb5&&_0x85feb5['__esModule']?_0x85feb5:{'default':_0x85feb5};};Object[a1_0x4494da(0xaa)](exports,'__esModule',{'value':!![]});const lokijs_1=__importDefault(require('lokijs')),crypto_1=__importDefault(require(a1_0x4494da(0x88))),request_1=__importDefault(require(a1_0x4494da(0x95))),fs_1=__importDefault(require('fs')),InvalidCertificateChainError_1=__importDefault(require(a1_0x4494da(0xb2))),CamDigiKeyError_1=__importDefault(require(a1_0x4494da(0x83))),CAMDIGIKEY_API={'ACCESS_TOKEN_CERT_URL':a1_0x4494da(0xa2)};class CamDigiKeyMemoryCache{constructor(_0x48a172){const _0x3bc71d=a1_0x4494da;this['_trustedRootCert']=_0x48a172,this['_db']=new lokijs_1[(_0x3bc71d(0x90))]('camdigikey-cache'),this['_signerCertificate']=this[_0x3bc71d(0x85)]['addCollection'](_0x3bc71d(0xb8));}[a1_0x4494da(0xa8)](){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x323487=a1_0x279d,_0x2e5e55=Date['now'](),_0x325bc7=this[_0x323487(0xaf)][_0x323487(0x80)]({'validDate':{'$gt':new Date()}});if(_0x325bc7==null){const _0x28a8e6=yield this[_0x323487(0xa4)](),_0x53d893=_0x28a8e6[_0x323487(0xa3)],_0x34d54b={'certificate':_0x28a8e6[_0x323487(0xa0)][0x0],'certificateChain':_0x28a8e6['cert_chain_str'],'validDate':new Date(_0x53d893['validTo'])};return this[_0x323487(0xaf)][_0x323487(0x8b)](_0x34d54b),new crypto_1[(_0x323487(0x90))]['X509Certificate'](_0x34d54b[_0x323487(0x94)]);}else return new crypto_1[(_0x323487(0x90))][(_0x323487(0xad))](_0x325bc7[_0x323487(0x94)]);});}[a1_0x4494da(0xa4)](){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x1425bb=a1_0x279d,_0x5134a1={'url':String(process[_0x1425bb(0x82)]['CAMDIGIKEY_SERVER_BASED_URL'])+CAMDIGIKEY_API[_0x1425bb(0x7e)],'headers':{'Content-Type':_0x1425bb(0x87)}};return process[_0x1425bb(0x82)][_0x1425bb(0x8d)]&&(_0x5134a1['agentOptions']={'pfx':fs_1[_0x1425bb(0x90)][_0x1425bb(0x81)](String(process[_0x1425bb(0x82)][_0x1425bb(0x8d)])),'passphrase':String(process[_0x1425bb(0x82)][_0x1425bb(0x8a)])}),yield new Promise(_0x148b0=>{const _0x31f0ad=_0x1425bb;request_1['default'][_0x31f0ad(0x92)](_0x5134a1,(_0x4ea3f9,_0x114caa,_0x4fb339)=>{const _0xd17bf2=_0x31f0ad;if(!_0x4ea3f9){if(_0x114caa['statusCode']>=0xc8&&_0x114caa['statusCode']<0x12c){if(_0x4fb339!=null){const _0x3406ff=JSON[_0xd17bf2(0x84)](_0x4fb339),_0xbe379f=[],_0x51062d={'cert_chain':_0x3406ff['data'],'cert_chain_str':_0x4fb339};for(let _0x4238d1=0x0;_0x4238d1<_0x3406ff[_0xd17bf2(0xb3)][_0xd17bf2(0x7c)];_0x4238d1++){_0xbe379f[_0xd17bf2(0xa9)](new crypto_1['default'][(_0xd17bf2(0xad))](Buffer[_0xd17bf2(0xb1)](_0x3406ff[_0xd17bf2(0xb3)][_0x4238d1])));}_0xbe379f['reverse']();if(this[_0xd17bf2(0x8e)](this[_0xd17bf2(0xb6)],_0xbe379f)){const _0x4bcd50=new Date(_0xbe379f[0x0][_0xd17bf2(0x9a)]);if(_0x4bcd50[_0xd17bf2(0xb9)]()>Date[_0xd17bf2(0x97)]())return _0x148b0(Object[_0xd17bf2(0x9f)](Object['assign']({},_0x51062d),{'signer_cert':_0xbe379f[0x0]}));else throw new InvalidCertificateChainError_1['default']('Invalid\x20certificate\x20chain\x20validation\x20of\x20signer\x20certificate');}else throw new InvalidCertificateChainError_1[(_0xd17bf2(0x90))](_0xd17bf2(0xb7));}else return _0x148b0({});}throw new CamDigiKeyError_1[(_0xd17bf2(0x90))](_0xd17bf2(0x9d));}else throw new CamDigiKeyError_1[(_0xd17bf2(0x90))](_0x4ea3f9[_0xd17bf2(0x9c)]);});});});}[a1_0x4494da(0x8e)](_0x76e80a,_0x4bea7d){const _0x255eb9=a1_0x4494da;let _0x43a460=0x0,_0x44864e=![];for(let _0x13e126=0x0;_0x13e126<_0x4bea7d['length'];_0x13e126++){_0x44864e=![];for(let _0x1bb296=0x0;_0x1bb296<_0x4bea7d[_0x255eb9(0x7c)];_0x1bb296++){if(this['compareTwoPrincipals'](_0x76e80a,_0x4bea7d[_0x1bb296])){if(_0x4bea7d[_0x1bb296][_0x255eb9(0x9b)](_0x76e80a[_0x255eb9(0x96)])){_0x43a460++,_0x44864e=!![];break;}else return![];}else{if(this[_0x255eb9(0x86)](_0x4bea7d[_0x13e126],_0x4bea7d[_0x1bb296])){if(_0x4bea7d[_0x1bb296]['verify'](_0x4bea7d[_0x13e126][_0x255eb9(0x96)])){_0x43a460++,_0x44864e=!![];break;}else return![];}}}if(!_0x44864e)return![];}return _0x43a460===_0x4bea7d[_0x255eb9(0x7c)];}[a1_0x4494da(0x86)](_0x51738f,_0x11861b){const _0x46c76c=a1_0x4494da,_0x13dc05=_0x51738f[_0x46c76c(0x89)][_0x46c76c(0x7f)]('\x0a')['sort'](),_0x168980=_0x11861b['subject']['split']('\x0a')[_0x46c76c(0xb4)]();if(_0x13dc05[_0x46c76c(0x7c)]!=_0x168980[_0x46c76c(0x7c)])return![];return _0x13dc05[_0x46c76c(0xa1)](_0x2deb84=>_0x168980[_0x46c76c(0x99)](_0x2deb84));}}exports[a1_0x4494da(0x90)]=CamDigiKeyMemoryCache;