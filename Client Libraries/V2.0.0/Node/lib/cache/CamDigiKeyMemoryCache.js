'use strict';const a2_0x324561=a2_0x6d11;function a2_0x5ad1(){const _0x46a453=['value','getTime','../api','next','crypto','apply','split','_db','validTo','findOne','defineProperty','220pfKiPB','X509Certificate','certificate','length','default','addCollection','386352jqERxy','subject','parse','../error/CamDigiKeyError','application/json','CAMDIGIKEY_CLIENT_KEYSTORE_FILE_PASSWORD','done','539656fhpsze','env','data','CAMDIGIKEY_API','publicKey','every','_trustedRootCert','verifyCertificateChain','Invalid\x20certificate\x20chain\x20validation\x20of\x20signer\x20certificate','signerCertificate','then','__importDefault','request','CAMDIGIKEY_CLIENT_KEYSTORE_FILE','9479070piBxig','camdigikey_signer_certificates','Error\x20requesting\x20to\x20CamDigiKey\x20Server.','__awaiter','now','statusCode','sort','cert_chain','compareTwoPrincipals','48042LwlyuK','35FKQrjh','agentOptions','verify','675144xRqplr','63WTulzX','readFileSync','../error/InvalidCertificateChainError','236449BGepwk','get','10148Zgsgfg','assign','_signerCertificate','signer_cert'];a2_0x5ad1=function(){return _0x46a453;};return a2_0x5ad1();}(function(_0x378194,_0x43d026){const _0x2b0a17=a2_0x6d11,_0x14750d=_0x378194();while(!![]){try{const _0x1b3c0e=-parseInt(_0x2b0a17(0x98))/0x1+parseInt(_0x2b0a17(0x94))/0x2+-parseInt(_0x2b0a17(0x72))/0x3+-parseInt(_0x2b0a17(0x9a))/0x4*(parseInt(_0x2b0a17(0x6c))/0x5)+-parseInt(_0x2b0a17(0x90))/0x6*(parseInt(_0x2b0a17(0x91))/0x7)+parseInt(_0x2b0a17(0x79))/0x8*(-parseInt(_0x2b0a17(0x95))/0x9)+parseInt(_0x2b0a17(0x87))/0xa;if(_0x1b3c0e===_0x43d026)break;else _0x14750d['push'](_0x14750d['shift']());}catch(_0x138ed8){_0x14750d['push'](_0x14750d['shift']());}}}(a2_0x5ad1,0x485c0));var __awaiter=this&&this[a2_0x324561(0x8a)]||function(_0x501434,_0x44060b,_0x2f18bf,_0x4eae73){function _0x100275(_0x5cfac9){return _0x5cfac9 instanceof _0x2f18bf?_0x5cfac9:new _0x2f18bf(function(_0x49de44){_0x49de44(_0x5cfac9);});}return new(_0x2f18bf||(_0x2f18bf=Promise))(function(_0x109856,_0x368da8){const _0x9cb30c=a2_0x6d11;function _0x312701(_0x4d3dfa){const _0x50c478=a2_0x6d11;try{_0x5cd1a1(_0x4eae73[_0x50c478(0xa1)](_0x4d3dfa));}catch(_0x4bc652){_0x368da8(_0x4bc652);}}function _0x5203e8(_0x2b38d7){try{_0x5cd1a1(_0x4eae73['throw'](_0x2b38d7));}catch(_0x160605){_0x368da8(_0x160605);}}function _0x5cd1a1(_0x3d1e5e){const _0x122ac4=a2_0x6d11;_0x3d1e5e[_0x122ac4(0x78)]?_0x109856(_0x3d1e5e[_0x122ac4(0x9e)]):_0x100275(_0x3d1e5e[_0x122ac4(0x9e)])[_0x122ac4(0x83)](_0x312701,_0x5203e8);}_0x5cd1a1((_0x4eae73=_0x4eae73[_0x9cb30c(0xa3)](_0x501434,_0x44060b||[]))['next']());});},__importDefault=this&&this[a2_0x324561(0x84)]||function(_0x5e2e85){return _0x5e2e85&&_0x5e2e85['__esModule']?_0x5e2e85:{'default':_0x5e2e85};};Object[a2_0x324561(0x6b)](exports,'__esModule',{'value':!![]});const lokijs_1=__importDefault(require('lokijs')),crypto_1=__importDefault(require(a2_0x324561(0xa2))),request_1=__importDefault(require(a2_0x324561(0x85))),fs_1=__importDefault(require('fs')),InvalidCertificateChainError_1=__importDefault(require(a2_0x324561(0x97))),CamDigiKeyError_1=__importDefault(require(a2_0x324561(0x75))),api_1=require(a2_0x324561(0xa0));function a2_0x6d11(_0x534570,_0xb7c3ca){const _0x5ad1ca=a2_0x5ad1();return a2_0x6d11=function(_0x6d11a5,_0x42626a){_0x6d11a5=_0x6d11a5-0x68;let _0x542715=_0x5ad1ca[_0x6d11a5];return _0x542715;},a2_0x6d11(_0x534570,_0xb7c3ca);}class CamDigiKeyMemoryCache{constructor(_0x55f993){const _0x2466b2=a2_0x324561;this['_trustedRootCert']=_0x55f993,this[_0x2466b2(0x68)]=new lokijs_1[(_0x2466b2(0x70))]('camdigikey-cache'),this[_0x2466b2(0x9c)]=this[_0x2466b2(0x68)][_0x2466b2(0x71)](_0x2466b2(0x88));}[a2_0x324561(0x82)](){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x35495a=a2_0x6d11,_0x439ecd=Date[_0x35495a(0x8b)](),_0x16d09e=this[_0x35495a(0x9c)][_0x35495a(0x6a)]({'validDate':{'$gt':new Date()}});if(_0x16d09e==null){const _0x2cb35d=yield this['getCertificateFromCamDigiKey'](),_0x5ec165=_0x2cb35d[_0x35495a(0x9d)],_0x45c595={'certificate':_0x2cb35d[_0x35495a(0x8e)][0x0],'certificateChain':_0x2cb35d['cert_chain_str'],'validDate':new Date(_0x5ec165[_0x35495a(0x69)])};return this[_0x35495a(0x9c)]['insert'](_0x45c595),new crypto_1[(_0x35495a(0x70))][(_0x35495a(0x6d))](_0x45c595[_0x35495a(0x6e)]);}else return new crypto_1[(_0x35495a(0x70))][(_0x35495a(0x6d))](_0x16d09e[_0x35495a(0x6e)]);});}['getCertificateFromCamDigiKey'](){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x2378e3=a2_0x6d11,_0x261b7f={'url':String(process[_0x2378e3(0x7a)]['CAMDIGIKEY_SERVER_BASED_URL'])+api_1[_0x2378e3(0x7c)]['ACCESS_TOKEN_CERT_URL'],'headers':{'Content-Type':_0x2378e3(0x76)}};return process['env'][_0x2378e3(0x86)]&&(_0x261b7f[_0x2378e3(0x92)]={'pfx':fs_1[_0x2378e3(0x70)][_0x2378e3(0x96)](String(process['env'][_0x2378e3(0x86)])),'passphrase':String(process[_0x2378e3(0x7a)][_0x2378e3(0x77)])}),yield new Promise(_0x3ab87e=>{const _0x475107=_0x2378e3;request_1[_0x475107(0x70)][_0x475107(0x99)](_0x261b7f,(_0x5afed9,_0x31b467,_0x3de0c8)=>{const _0x3dd649=_0x475107;if(!_0x5afed9){if(_0x31b467[_0x3dd649(0x8c)]>=0xc8&&_0x31b467[_0x3dd649(0x8c)]<0x12c){if(_0x3de0c8!=null){const _0x51f03d=JSON[_0x3dd649(0x74)](_0x3de0c8),_0x4a87d3=[],_0x9d966f={'cert_chain':_0x51f03d[_0x3dd649(0x7b)],'cert_chain_str':_0x3de0c8};for(let _0x1e8f87=0x0;_0x1e8f87<_0x51f03d['data'][_0x3dd649(0x6f)];_0x1e8f87++){_0x4a87d3['push'](new crypto_1[(_0x3dd649(0x70))][(_0x3dd649(0x6d))](Buffer['from'](_0x51f03d[_0x3dd649(0x7b)][_0x1e8f87])));}_0x4a87d3['reverse']();if(this[_0x3dd649(0x80)](this[_0x3dd649(0x7f)],_0x4a87d3)){const _0x2e6b92=new Date(_0x4a87d3[0x0][_0x3dd649(0x69)]);if(_0x2e6b92[_0x3dd649(0x9f)]()>Date[_0x3dd649(0x8b)]())return _0x3ab87e(Object[_0x3dd649(0x9b)](Object['assign']({},_0x9d966f),{'signer_cert':_0x4a87d3[0x0]}));else throw new InvalidCertificateChainError_1[(_0x3dd649(0x70))](_0x3dd649(0x81));}else throw new InvalidCertificateChainError_1[(_0x3dd649(0x70))]('Invalid\x20certificate\x20chain\x20validation\x20of\x20signer\x20certificate');}else return _0x3ab87e({});}throw new CamDigiKeyError_1[(_0x3dd649(0x70))](_0x3dd649(0x89));}else throw new CamDigiKeyError_1[(_0x3dd649(0x70))](_0x5afed9['message']);});});});}[a2_0x324561(0x80)](_0x3d02ac,_0x18d8b3){const _0xa31605=a2_0x324561;let _0x4bcb4b=0x0,_0x44f5c1=![];for(let _0x398787=0x0;_0x398787<_0x18d8b3[_0xa31605(0x6f)];_0x398787++){_0x44f5c1=![];for(let _0x4915f6=0x0;_0x4915f6<_0x18d8b3[_0xa31605(0x6f)];_0x4915f6++){if(this['compareTwoPrincipals'](_0x3d02ac,_0x18d8b3[_0x4915f6])){if(_0x18d8b3[_0x4915f6]['verify'](_0x3d02ac[_0xa31605(0x7d)])){_0x4bcb4b++,_0x44f5c1=!![];break;}else return![];}else{if(this[_0xa31605(0x8f)](_0x18d8b3[_0x398787],_0x18d8b3[_0x4915f6])){if(_0x18d8b3[_0x4915f6][_0xa31605(0x93)](_0x18d8b3[_0x398787][_0xa31605(0x7d)])){_0x4bcb4b++,_0x44f5c1=!![];break;}else return![];}}}if(!_0x44f5c1)return![];}return _0x4bcb4b===_0x18d8b3[_0xa31605(0x6f)];}[a2_0x324561(0x8f)](_0x5e5f0b,_0x562d7a){const _0x35b052=a2_0x324561,_0x1f6474=_0x5e5f0b[_0x35b052(0x73)][_0x35b052(0xa4)]('\x0a')[_0x35b052(0x8d)](),_0x2df358=_0x562d7a['subject']['split']('\x0a')[_0x35b052(0x8d)]();if(_0x1f6474[_0x35b052(0x6f)]!=_0x2df358[_0x35b052(0x6f)])return![];return _0x1f6474[_0x35b052(0x7e)](_0x4e6637=>_0x2df358['includes'](_0x4e6637));}}exports['default']=CamDigiKeyMemoryCache;