'use strict';const a2_0xb2359c=a2_0x2027;(function(_0x28d224,_0x1004e0){const _0x1f6f42=a2_0x2027,_0x53c9de=_0x28d224();while(!![]){try{const _0x20f7f2=parseInt(_0x1f6f42(0x10c))/0x1+parseInt(_0x1f6f42(0xe4))/0x2+parseInt(_0x1f6f42(0xfd))/0x3+-parseInt(_0x1f6f42(0x108))/0x4*(-parseInt(_0x1f6f42(0xf0))/0x5)+-parseInt(_0x1f6f42(0xe6))/0x6*(parseInt(_0x1f6f42(0xf9))/0x7)+-parseInt(_0x1f6f42(0xe7))/0x8*(parseInt(_0x1f6f42(0x104))/0x9)+-parseInt(_0x1f6f42(0x10d))/0xa;if(_0x20f7f2===_0x1004e0)break;else _0x53c9de['push'](_0x53c9de['shift']());}catch(_0x1a21d0){_0x53c9de['push'](_0x53c9de['shift']());}}}(a2_0x1c09,0x1fd64));function a2_0x2027(_0x4f12a0,_0xd91658){const _0x1c099e=a2_0x1c09();return a2_0x2027=function(_0x202720,_0x5e90ad){_0x202720=_0x202720-0xd8;let _0x34df95=_0x1c099e[_0x202720];return _0x34df95;},a2_0x2027(_0x4f12a0,_0xd91658);}var __awaiter=this&&this['__awaiter']||function(_0x3dbf97,_0xb62298,_0xce8b39,_0x284c1d){function _0x188a03(_0xb66db7){return _0xb66db7 instanceof _0xce8b39?_0xb66db7:new _0xce8b39(function(_0x7fb32b){_0x7fb32b(_0xb66db7);});}return new(_0xce8b39||(_0xce8b39=Promise))(function(_0x584886,_0x4884a0){const _0xf82d0f=a2_0x2027;function _0x207bbc(_0x8e2a22){const _0x57dead=a2_0x2027;try{_0x369e3b(_0x284c1d[_0x57dead(0xe0)](_0x8e2a22));}catch(_0x334528){_0x4884a0(_0x334528);}}function _0x3b97c0(_0x364938){try{_0x369e3b(_0x284c1d['throw'](_0x364938));}catch(_0x150400){_0x4884a0(_0x150400);}}function _0x369e3b(_0x4db98f){const _0x2d66f7=a2_0x2027;_0x4db98f[_0x2d66f7(0xdc)]?_0x584886(_0x4db98f[_0x2d66f7(0x10b)]):_0x188a03(_0x4db98f[_0x2d66f7(0x10b)])[_0x2d66f7(0xe1)](_0x207bbc,_0x3b97c0);}_0x369e3b((_0x284c1d=_0x284c1d[_0xf82d0f(0xf5)](_0x3dbf97,_0xb62298||[]))[_0xf82d0f(0xe0)]());});},__importDefault=this&&this[a2_0xb2359c(0xfc)]||function(_0x376c38){return _0x376c38&&_0x376c38['__esModule']?_0x376c38:{'default':_0x376c38};};function a2_0x1c09(){const _0x54412e=['signer_cert','env','sort','next','then','default','getTime','374106JSOdvU','application/json','658914eXWcBm','2144roYCvl','split','verify','length','_trustedRootCert','validTo','Invalid\x20certificate\x20chain\x20validation\x20of\x20signer\x20certificate','cert_chain','assign','494660RKYPbT','camdigikey-cache','lokijs','camdigikey_signer_certificates','push','apply','now','CAMDIGIKEY_CLIENT_KEYSTORE_FILE','from','14wEUoJw','getCertificateFromCamDigiKey','statusCode','__importDefault','741045NbzqPq','every','subject','certificate','../error/InvalidCertificateChainError','data','ACCESS_TOKEN_CERT_URL','5067JDGqwD','_signerCertificate','CAMDIGIKEY_API','cert_chain_str','4LPTUHD','CAMDIGIKEY_SERVER_BASED_URL','../api','value','63322URNVeM','953960sjIhVW','parse','CAMDIGIKEY_CLIENT_KEYSTORE_FILE_PASSWORD','verifyCertificateChain','readFileSync','defineProperty','compareTwoPrincipals','__esModule','addCollection','message','X509Certificate','request','insert','_db','done'];a2_0x1c09=function(){return _0x54412e;};return a2_0x1c09();}Object[a2_0xb2359c(0x112)](exports,a2_0xb2359c(0x114),{'value':!![]});const lokijs_1=__importDefault(require(a2_0xb2359c(0xf2))),crypto_1=__importDefault(require('crypto')),request_1=__importDefault(require(a2_0xb2359c(0xd9))),fs_1=__importDefault(require('fs')),InvalidCertificateChainError_1=__importDefault(require(a2_0xb2359c(0x101))),CamDigiKeyError_1=__importDefault(require('../error/CamDigiKeyError')),api_1=require(a2_0xb2359c(0x10a));class CamDigiKeyMemoryCache{constructor(_0x1ed1e4){const _0x409393=a2_0xb2359c;this[_0x409393(0xeb)]=_0x1ed1e4,this[_0x409393(0xdb)]=new lokijs_1[(_0x409393(0xe2))](_0x409393(0xf1)),this[_0x409393(0x105)]=this[_0x409393(0xdb)][_0x409393(0x115)](_0x409393(0xf3));}['signerCertificate'](){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x8f7c9e=a2_0x2027,_0x352fc0=Date['now'](),_0xea2849=this[_0x8f7c9e(0x105)]['findOne']({'validDate':{'$gt':new Date()}});if(_0xea2849==null){const _0xec6160=yield this[_0x8f7c9e(0xfa)](),_0x5a8c51=_0xec6160[_0x8f7c9e(0xdd)],_0x122ccc={'certificate':_0xec6160[_0x8f7c9e(0xee)][0x0],'certificateChain':_0xec6160[_0x8f7c9e(0x107)],'validDate':new Date(_0x5a8c51[_0x8f7c9e(0xec)])};return this[_0x8f7c9e(0x105)][_0x8f7c9e(0xda)](_0x122ccc),new crypto_1['default']['X509Certificate'](_0x122ccc[_0x8f7c9e(0x100)]);}else return new crypto_1[(_0x8f7c9e(0xe2))][(_0x8f7c9e(0xd8))](_0xea2849[_0x8f7c9e(0x100)]);});}[a2_0xb2359c(0xfa)](){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x30adb6=a2_0x2027,_0x4fc1ad={'url':String(process[_0x30adb6(0xde)][_0x30adb6(0x109)])+api_1[_0x30adb6(0x106)][_0x30adb6(0x103)],'headers':{'Content-Type':_0x30adb6(0xe5)}};return process[_0x30adb6(0xde)][_0x30adb6(0xf7)]&&(_0x4fc1ad['agentOptions']={'pfx':fs_1['default'][_0x30adb6(0x111)](String(process['env']['CAMDIGIKEY_CLIENT_KEYSTORE_FILE'])),'passphrase':String(process[_0x30adb6(0xde)][_0x30adb6(0x10f)])}),yield new Promise(_0x478219=>{const _0x3f28d4=_0x30adb6;request_1[_0x3f28d4(0xe2)]['get'](_0x4fc1ad,(_0x39bc41,_0x5465fa,_0x482186)=>{const _0x1b1d2a=_0x3f28d4;if(!_0x39bc41){if(_0x5465fa[_0x1b1d2a(0xfb)]>=0xc8&&_0x5465fa[_0x1b1d2a(0xfb)]<0x12c){if(_0x482186!=null){const _0xb2cc1c=JSON[_0x1b1d2a(0x10e)](_0x482186),_0x508f20=[],_0x3303d6={'cert_chain':_0xb2cc1c[_0x1b1d2a(0x102)],'cert_chain_str':_0x482186};for(let _0x408844=0x0;_0x408844<_0xb2cc1c[_0x1b1d2a(0x102)]['length'];_0x408844++){_0x508f20[_0x1b1d2a(0xf4)](new crypto_1['default']['X509Certificate'](Buffer[_0x1b1d2a(0xf8)](_0xb2cc1c['data'][_0x408844])));}_0x508f20['reverse']();if(this[_0x1b1d2a(0x110)](this[_0x1b1d2a(0xeb)],_0x508f20)){const _0x3596dc=new Date(_0x508f20[0x0]['validTo']);if(_0x3596dc[_0x1b1d2a(0xe3)]()>Date[_0x1b1d2a(0xf6)]())return _0x478219(Object[_0x1b1d2a(0xef)](Object['assign']({},_0x3303d6),{'signer_cert':_0x508f20[0x0]}));else throw new InvalidCertificateChainError_1['default'](_0x1b1d2a(0xed));}else throw new InvalidCertificateChainError_1[(_0x1b1d2a(0xe2))]('Invalid\x20certificate\x20chain\x20validation\x20of\x20signer\x20certificate');}else return _0x478219({});}throw new CamDigiKeyError_1['default']('Error\x20requesting\x20to\x20CamDigiKey\x20Server.');}else throw new CamDigiKeyError_1[(_0x1b1d2a(0xe2))](_0x39bc41[_0x1b1d2a(0x116)]);});});});}[a2_0xb2359c(0x110)](_0x496ecb,_0x54a137){const _0x589d7c=a2_0xb2359c;let _0x224c53=0x0,_0x2d53eb=![];for(let _0x282762=0x0;_0x282762<_0x54a137[_0x589d7c(0xea)];_0x282762++){_0x2d53eb=![];for(let _0x41526b=0x0;_0x41526b<_0x54a137[_0x589d7c(0xea)];_0x41526b++){if(this[_0x589d7c(0x113)](_0x496ecb,_0x54a137[_0x41526b])){if(_0x54a137[_0x41526b][_0x589d7c(0xe9)](_0x496ecb['publicKey'])){_0x224c53++,_0x2d53eb=!![];break;}else return![];}else{if(this['compareTwoPrincipals'](_0x54a137[_0x282762],_0x54a137[_0x41526b])){if(_0x54a137[_0x41526b][_0x589d7c(0xe9)](_0x54a137[_0x282762]['publicKey'])){_0x224c53++,_0x2d53eb=!![];break;}else return![];}}}if(!_0x2d53eb)return![];}return _0x224c53===_0x54a137['length'];}[a2_0xb2359c(0x113)](_0x38f339,_0x431672){const _0x475874=a2_0xb2359c,_0x408936=_0x38f339[_0x475874(0xff)]['split']('\x0a')[_0x475874(0xdf)](),_0x2e5132=_0x431672[_0x475874(0xff)][_0x475874(0xe8)]('\x0a')['sort']();if(_0x408936[_0x475874(0xea)]!=_0x2e5132[_0x475874(0xea)])return![];return _0x408936[_0x475874(0xfe)](_0x1ca308=>_0x2e5132['includes'](_0x1ca308));}}exports[a2_0xb2359c(0xe2)]=CamDigiKeyMemoryCache;